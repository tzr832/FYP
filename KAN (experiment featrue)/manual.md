# ğŸš€ çº¦æŸå‹ KAN ç½‘ç»œå±‚ (MonotonicKANLayer) å·¥ç¨‹æ–‡æ¡£

## ğŸ“ 1. ç®€ä»‹ä¸è®¾è®¡åŸåˆ™

`MonotonicKANLayer` æ˜¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„ PyTorch æ¨¡å—ï¼Œç”¨äºæ‹Ÿåˆæ»¡è¶³ç‰¹å®šç‰©ç†çº¦æŸçš„å‡½æ•°ç»“æ„ï¼š$NN(t,s) = a(s) + \sum_k G_k(t)H_k(s)$ã€‚

**è®¾è®¡åŸåˆ™ï¼š**

1.  **ç»“æ„åŒ–ç¡¬ç¼–ç ï¼š** ä½¿ç”¨å‚æ•°åŒ–æŠ€å·§ï¼ˆå¦‚ $\text{softplus}$ çº¦æŸç³»æ•°ï¼‰å’Œå¤–éƒ¨åŒ…è£…å™¨ï¼ˆå¦‚ $\text{softplus}(\cdot)$ï¼‰æ¥ç¡¬ç¼–ç çº¦æŸã€‚
2.  **å‘é‡åŒ–è®¡ç®—ï¼š** åˆ©ç”¨å‘é‡åŒ–æŠ€æœ¯ï¼ˆé€šè¿‡ PyKAN çš„ `B_batch` å‡½æ•°ï¼‰åŒæ­¥é«˜æ•ˆè®¡ç®—å¤šä¸ªæ ·æœ¬ï¼ˆBatchï¼‰å’Œå¤šä¸ªç‰¹å¾ï¼ˆ$t$ å’Œ $s$ï¼‰ä¸Šçš„ B æ ·æ¡åŸºå‡½æ•°ã€‚
3.  **æ¨¡å—åŒ–è®¾è®¡ï¼š** å°†ä¸åŒçº¦æŸçš„å‡½æ•°æ‹†åˆ†ä¸ºå•ç‹¬çš„ç±» (`GFunc`, `HFunc`, `AFunc`)ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¤ç”¨æ€§ã€‚

-----

## ğŸ—ï¸ 2. åŸºç±»è®¾è®¡ï¼š`BSplineBase`

`BSplineBase` è´Ÿè´£å¤„ç†æ‰€æœ‰ä¸ B æ ·æ¡è®¡ç®—ç›¸å…³çš„é€šç”¨é€»è¾‘ï¼ŒåŒ…æ‹¬ç½‘æ ¼åˆå§‹åŒ–ã€ç³»æ•°æ•°é‡ç¡®å®šã€ä»¥åŠè°ƒç”¨åº•å±‚çš„ B æ ·æ¡è®¡ç®—å‡½æ•°ã€‚

### class `BSplineBase`

| æè¿° | åŠŸèƒ½å’Œä½œç”¨ |
| :--- | :--- |
| **ç»§æ‰¿** | `torch.nn.Module` |
| **åŠŸèƒ½** | æä¾› B æ ·æ¡ç½‘ç»œçš„é€šç”¨ç»“æ„å’Œåˆå§‹åŒ–ï¼ŒåŒ…å«ç½‘æ ¼ç‚¹çš„ç”Ÿæˆå’Œ B æ ·æ¡é˜¶æ•°çš„å®šä¹‰ã€‚ |
| **å±æ€§** | |
| `k` | B æ ·æ¡çš„é˜¶æ•° (int, é»˜è®¤ä¸º 3)ã€‚ |
| `num_grids` | å†…éƒ¨ç½‘æ ¼ç‚¹çš„æ•°é‡ $G$ã€‚ |
| `N_coef` | B æ ·æ¡ç³»æ•°çš„æ€»æ•°é‡ $G + k - 1$ã€‚ |
| `grid` | æ‰©å±•åçš„ B æ ·æ¡ç½‘æ ¼ç‚¹ (Buffer)ï¼Œç”¨äº `coef2curve`ã€‚ |
| **æ–¹æ³•** | |
| `__init__` | åˆå§‹åŒ–ç½‘æ ¼ç‚¹ï¼Œå¹¶è°ƒç”¨ `extend_grid` ç”Ÿæˆæ‰©å±•ç½‘æ ¼ã€‚|
| `_compute_spline_curve(x, coef)` | è¾…åŠ©æ–¹æ³•ï¼Œè°ƒç”¨ `coef2curve` å®ç°å‘é‡åŒ–çš„ B æ ·æ¡æ›²çº¿è®¡ç®—ã€‚ |
| **è¾“å…¥** | `x`: è¾“å…¥æ•°æ®ï¼Œshape `(B, 1)` |
| `coef`: B æ ·æ¡ç³»æ•°ï¼Œshape `(out_features, in_features, N_coef)` |
| **è¾“å‡º** | `y_eval`: B æ ·æ¡æ›²çº¿åœ¨ $x$ å¤„çš„å–å€¼ï¼Œshape `(B, in_features, out_features)`|

-----

## ğŸ“ 3. å®šåˆ¶åŒ–å‡½æ•°ç±»

åŸºäº `BSplineBase` å®ç°ä¸‰ç§ä¸åŒçº¦æŸçš„ KAN èŠ‚ç‚¹å‡½æ•°ã€‚

### 3.1. $H_k(s)$ å’Œ $a(s)$ çš„å•è°ƒçº¦æŸå‡½æ•°

è¯¥ç±»ç”¨äº $a(s)$ (è¾“å‡º $1$) å’Œ $H_k(s)$ (è¾“å‡º $H$)ï¼Œè¦æ±‚ $f(0)=0$ å’Œ $f'(s) > 0$ã€‚

### class `MonotonicFunc`

| æè¿° | åŠŸèƒ½å’Œä½œç”¨ |
| :--- | :--- |
| **ç»§æ‰¿** | `BSplineBase` |
| **åŠŸèƒ½** | å®ç° $f(s) = w \cdot s + \text{spline}(s)$ çš„ç»“æ„ï¼Œå¹¶é€šè¿‡çº¦æŸç³»æ•° $c_i$ ä¿è¯å•è°ƒæ€§å’Œé›¶ç‚¹è¾¹ç•Œã€‚ |
| **å‚æ•°** | `in_features=1`, `out_features` (1 for $a(s)$, $H$ for $H_k(s)$) |
|**å¤‡æ³¨**|1. å®é™…æ“ä½œä¸­éœ€è¦ $w>0$ ,å› æ­¤å¯ä»¥é‡‡ç”¨$w = \text{softplus}(w_{raw})$çš„è®¾è®¡ã€‚ 2.è‹¥è¦æ±‚ä¸‰é˜¶Bæ ·æ¡å‡½æ•°åœ¨0å¤„å€¼ä¸º0ï¼Œå¯èƒ½éœ€è¦å‚æ•°`c_n`çš„å‰è‹¥å¹²é¡¹éƒ½ä¸º0ï¼Œéœ€è¦å¦¥å–„å¤„ç†ç½‘æ ¼è¾¹ç•Œå¯¹äºå‡½æ•°å€¼å’Œå¯¼æ•°å€¼çš„çº¦æŸ|
| **å¯å­¦ä¹ å‚æ•°** | |
| `d` | æ ·æ¡ç³»æ•°çš„å¢é‡ $\Delta c_i$ (Parameter)ï¼Œshape `(out, in, N_coef)`ã€‚|
| `w_raw`| çº¿æ€§åŸºå‡½æ•°é¡¹ $w$ çš„æƒé‡ (Parameter)ï¼Œç”¨äº $w \cdot s$ã€‚($w = \text{softplus}(w_{raw})$)|
| **æ–¹æ³•** | |
| `get_spline_coefficients()` | **æ ¸å¿ƒæ–¹æ³•ã€‚** é€šè¿‡ $\text{softplus}(d)$ è®¡ç®—å¢é‡ $\Delta c$ï¼Œç„¶åç´¯ç§¯æ±‚å’Œï¼Œå¹¶å¼ºåˆ¶ $c_1=0$ã€‚|
| **è¾“å‡º** | `c`: å•è°ƒç³»æ•° $c_i$ï¼Œshape `(out, in, N_coef)`ã€‚ |
| `forward(x)` | å®ç° $f(s) = w \cdot s + S(s)$ã€‚|
| **è¾“å…¥** | `x`: $s$ è¾“å…¥ï¼Œshape `(B, 1)`ã€‚ |
| **è¾“å‡º** | `f_s`: å•è°ƒå‡½æ•°å€¼ï¼Œshape `(B, out_features)`ã€‚ |

### 3.2. $G_k(t)$ çš„æ’æ­£çº¦æŸå‡½æ•°

è¯¥ç±»ç”¨äº $G_k(t)$ï¼Œè¦æ±‚ $G_k(t) > 0$ï¼Œä½¿ç”¨ $\text{softplus}$ åŒ…è£…å™¨ä¿è¯æ•°å€¼ç¨³å®šã€‚

### class `GFunc`

| æè¿° | åŠŸèƒ½å’Œä½œç”¨ |
| :--- | :--- |
| **ç»§æ‰¿** | `BSplineBase` |
| **åŠŸèƒ½** | å®ç° $G_k(t) = \text{softplus}(\text{silu}(t) + \text{spline}(t))$ çš„ç»“æ„ï¼Œæä¾›æœ€å¤§çš„æ‹Ÿåˆçµæ´»æ€§ã€‚|
| **å‚æ•°** | `in_features=1`, `out_features=$H$ (hidden_dim)` |
| **å¯å­¦ä¹ å‚æ•°** | |
| `coef` | æ ·æ¡ç³»æ•° $c_i$ (Parameter)ï¼Œ**æ— å•è°ƒçº¦æŸ**ã€‚|
| `linear` | å¯é€‰çš„çº¿æ€§å±‚ï¼Œç”¨äºæ¨¡æ‹Ÿ $b(t)$ æˆ–ä½œä¸ºåˆå§‹æ˜ å°„ã€‚|
| **æ–¹æ³•** | |
| `forward(x)` | å®ç° $G_k(t)$ çš„å‰å‘ä¼ æ’­ã€‚|
| **å†…éƒ¨é€»è¾‘** | 1. è®¡ç®—å†…éƒ¨å‡½æ•° $\tilde{G}_k(t) = \text{silu}(t) + \text{spline}(t)$ã€‚|
| 2. å¯¹ $\tilde{G}_k(t)$ åº”ç”¨ $\text{softplus}$ åŒ…è£…å™¨ã€‚|
| **è¾“å…¥** | `x`: $t$ è¾“å…¥ï¼Œshape `(B, 1)`ã€‚ |
| **è¾“å‡º** | $G_t$: æ’æ­£å‡½æ•°å€¼ï¼Œshape `(B, out_features)`ã€‚ |

-----

## âš¡ 4. æ€»æ–¹æ¡ˆï¼š`MonotonicKANLayer`

è¯¥ç±»é›†æˆä»¥ä¸Šæ‰€æœ‰å®šåˆ¶å‡½æ•°ï¼Œå®ç° $NN(t,s)$ çš„æœ€ç»ˆè®¡ç®—ã€‚

### class `MonotonicKANLayer`

| æè¿° | åŠŸèƒ½å’Œä½œç”¨ |
| :--- | :--- |
| **ç»§æ‰¿** | `torch.nn.Module` |
| **åŠŸèƒ½** | ç»„åˆ $a(s)$, $G_k(t)$, $H_k(s)$ å®ç°æœ€ç»ˆçš„ $NN(t,s)$ è¡¨è¾¾å¼ï¼Œå¹¶è¿›è¡Œå‘é‡åŒ–æ±‚å’Œã€‚ |
| **å‚æ•°** | `hidden_dim=$H$`, `num_grids`|
| **å†…éƒ¨æ¨¡å—** | |
| `a_s_func` | `MonotonicFunc` å®ä¾‹ï¼Œ`out_features=1`ã€‚ |
| `H_s_func` | `MonotonicFunc` å®ä¾‹ï¼Œ`out_features=$H$`ã€‚ |
| `G_t_func` | `GFunc` å®ä¾‹ï¼Œ`out_features=$H$`ã€‚ |
| **æ–¹æ³•** | |
| `forward(x)` | å®ç°äº† $NN(t,s) = a(s) + \sum_k G_k(t)H_k(s)$ çš„å‘é‡åŒ–è®¡ç®—ã€‚|
| **è¾“å…¥** | `x`: ç½‘ç»œçš„æ€»è¾“å…¥ $[t, s]$ï¼Œshape `(B, 2)`ã€‚ |
| **æ­¥éª¤** | 1. åˆ†ç¦» $t$ å’Œ $s$ è¾“å…¥ï¼š$t = x[:, 0:1]$, $s = x[:, 1:2]$ã€‚|
| 2. è®¡ç®— $a(s) = \text{a\_s\_func}(s)$ã€‚|
| 3. è®¡ç®— $G_k(t) = \text{G\_t\_func}(t)$ã€‚|
| 4. è®¡ç®— $H_k(s) = \text{H\_s\_func}(s)$ã€‚|
| 5. å‘é‡åŒ–ä¹˜ç§¯ï¼š$\text{product\_term} = G_k(t) \odot H_k(s)$ï¼Œshape `(B, H)`ã€‚|
| 6. æ²¿ $H$ ç»´åº¦æ±‚å’Œï¼š$\text{sum\_term} = \sum_k (\text{product\_term})$ï¼Œshape `(B, 1)`ã€‚|
| 7. æœ€ç»ˆè¾“å‡º $NN(t,s) = a(s) + \text{sum\_term}$ã€‚|
| **è¾“å‡º** | `NN_ts`: é¢„æµ‹å€¼ï¼Œshape `(B, 1)`ã€‚ |

-----

## âš™ï¸ 5. å‘é‡åŒ– B æ ·æ¡è¾…åŠ©å‡½æ•°ï¼ˆ`spline.py`ï¼‰

| Function | æè¿° | è¾“å…¥ | è¾“å‡º |
| :--- | :--- | :--- | :--- |
| `B_batch` | å‘é‡åŒ–è®¡ç®— $k$ é˜¶ B æ ·æ¡åŸºå‡½æ•°çš„å€¼ã€‚ | `x`: è¾“å…¥ç‚¹ï¼Œshape `(num_splines, B)` | `spline values`: åŸºå‡½æ•°å€¼ï¼Œshape `(B, in_dim, G+k)` |
| `coef2curve` | å°† B æ ·æ¡ç³»æ•°è½¬åŒ–ä¸ºæ›²çº¿å€¼ï¼ˆå³æ ·æ¡å‡½æ•° $S(x)$ï¼‰ã€‚ | `x_eval`: è¾“å…¥ç‚¹ï¼Œshape `(B, in_dim)`<br>`grid`: æ‰©å±•ç½‘æ ¼ï¼Œshape `(in_dim, G+2k)`<br>`coef`: æ ·æ¡ç³»æ•°ï¼Œshape `(in_dim, out_dim, G+k)`| `y_eval`: æ ·æ¡å‡½æ•°å€¼ï¼Œshape `(B, in_dim, out_dim)` |
| `extend_grid` | æ‰©å±•ç½‘æ ¼ï¼Œç”¨äºæ»¡è¶³ B æ ·æ¡åœ¨è¾¹ç•Œå¤„çš„æ”¯æ’‘è¦æ±‚ã€‚ | `grid`: åˆå§‹ç½‘æ ¼ç‚¹ | `grid`: æ‰©å±•åçš„ç½‘æ ¼ç‚¹ |