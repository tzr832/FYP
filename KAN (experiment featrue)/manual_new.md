# ğŸš€ çº¦æŸå‹ KAN ç½‘ç»œå±‚ (MonotonicKANLayer) å·¥ç¨‹æ–‡æ¡£ï¼ˆæ›´æ–°ï¼šé¡¹ç›®ç¬¦å·ç»“æ„ï¼‰

## ğŸ“ 1. ç®€ä»‹ä¸è®¾è®¡åŸåˆ™

`MonotonicKANLayer` æ˜¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„ PyTorch æ¨¡å—ï¼Œç”¨äºæ‹Ÿåˆæ»¡è¶³ç‰¹å®šç‰©ç†çº¦æŸçš„å‡½æ•°ç»“æ„ï¼š$NN(t,s) = a(s) + \sum_k G_k(t)H_k(s)$ã€‚

**æ ¸å¿ƒæ”¹è¿›ç›®æ ‡:** è§£å†³åœ¨ $s=0$ å’Œ $s=t$ è¾¹ç•Œå¤„å‡½æ•°å€¼éœ‡è¡çš„é—®é¢˜ã€‚é€šè¿‡å¼•å…¥**æŒ‡æ•°è¡°å‡å¯¼æ•°åŸºå‡½æ•°**å’Œ**éçº¿æ€§ Chebyshev å˜æ¢**ï¼Œå°†æ ·æ¡æ‹Ÿåˆèƒ½åŠ›é›†ä¸­åˆ°è¾¹ç•Œï¼ŒåŒæ—¶ä¿æŒ $\psi(0)=0$ å’Œ $\psi'(s) \ge 0$ çš„çº¦æŸã€‚

**è®¾è®¡åŸåˆ™ï¼š**

* **ç»“æ„åŒ–ç¡¬ç¼–ç ï¼š** ä½¿ç”¨å‚æ•°åŒ–æŠ€å·§ï¼ˆå¦‚ $\text{softplus}$ çº¦æŸç³»æ•°ï¼‰å’Œå¤–éƒ¨åŒ…è£…å™¨ï¼ˆå¦‚ $\text{softplus}(\cdot)$ï¼‰æ¥ç¡¬ç¼–ç çº¦æŸã€‚
* **è¾¹ç•Œå¢å¼º B æ ·æ¡ï¼š** å¯¹ $s$ è¾“å…¥è¿›è¡Œ $\mathbf{\arccos}$ å˜æ¢ï¼Œå°† $s \in [0, t]$ æ˜ å°„åˆ° $z \in [0, \pi]$ï¼Œå®ç°è¾¹ç•Œç½‘æ ¼çš„è‡ªåŠ¨å¯†é›†åŒ–ã€‚
* **å‘é‡åŒ–è®¡ç®—ï¼š** åˆ©ç”¨å‘é‡åŒ–æŠ€æœ¯ï¼ˆé€šè¿‡ PyKAN çš„ `B_batch` å‡½æ•°ï¼‰åŒæ­¥é«˜æ•ˆè®¡ç®—å¤šä¸ªæ ·æœ¬ï¼ˆBatchï¼‰å’Œå¤šä¸ªç‰¹å¾ï¼ˆ$t$ å’Œ $s$ï¼‰ä¸Šçš„ B æ ·æ¡åŸºå‡½æ•°ã€‚
* **æ¨¡å—åŒ–è®¾è®¡ï¼š** å°†ä¸åŒçº¦æŸçš„å‡½æ•°æ‹†åˆ†ä¸ºå•ç‹¬çš„ç±» (`GFunc`, `HFunc`, `AFunc`)ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¤ç”¨æ€§ã€‚

-----

## ğŸ—ï¸ 2. åŸºç±»è®¾è®¡ï¼š`BSplineBase`

`BSplineBase` è´Ÿè´£å¤„ç†æ‰€æœ‰ä¸ B æ ·æ¡è®¡ç®—ç›¸å…³çš„é€šç”¨é€»è¾‘ï¼ŒåŒ…æ‹¬ç½‘æ ¼åˆå§‹åŒ–ã€ç³»æ•°æ•°é‡ç¡®å®šã€ä»¥åŠè°ƒç”¨åº•å±‚çš„ B æ ·æ¡è®¡ç®—å‡½æ•°ã€‚

### class `BSplineBase`

* **ç»§æ‰¿ï¼š** `torch.nn.Module`
* **åŠŸèƒ½ï¼š** æä¾› B æ ·æ¡ç½‘ç»œçš„é€šç”¨ç»“æ„å’Œåˆå§‹åŒ–ï¼ŒåŒ…å«ç½‘æ ¼ç‚¹çš„ç”Ÿæˆå’Œ B æ ·æ¡é˜¶æ•°çš„å®šä¹‰ã€‚
* **å±æ€§ï¼š**
    * `k`ï¼šB æ ·æ¡çš„é˜¶æ•° (int, é»˜è®¤ä¸º 3)ã€‚
    * `num_grids`ï¼šå†…éƒ¨ç½‘æ ¼ç‚¹çš„æ•°é‡ $G$ã€‚
    * `N_coef`ï¼šB æ ·æ¡ç³»æ•°çš„æ€»æ•°é‡ $G + k - 1$ã€‚
    * `grid`ï¼šæ‰©å±•åçš„ B æ ·æ¡ç½‘æ ¼ç‚¹ (Buffer)ï¼Œç”¨äº `coef2curve`ã€‚
* **æ–¹æ³•ï¼š**
    * `__init__`ï¼šåˆå§‹åŒ–ç½‘æ ¼ç‚¹ï¼Œå¹¶è°ƒç”¨ `extend_grid` ç”Ÿæˆæ‰©å±•ç½‘æ ¼ã€‚
    * `_compute_spline_curve(x, coef)`ï¼šè¾…åŠ©æ–¹æ³•ï¼Œè°ƒç”¨ `coef2curve` å®ç°å‘é‡åŒ–çš„ B æ ·æ¡æ›²çº¿è®¡ç®—ã€‚
        * **è¾“å…¥**ï¼š`x` (shape `(B, 1)`)ï¼›`coef` (shape `(out, in, N_coef)`)ã€‚
        * **è¾“å‡º**ï¼š`y_eval` (shape `(B, in_features, out_features)`)ã€‚

-----

## ğŸ“ 3. å®šåˆ¶åŒ–å‡½æ•°ç±»

### 3.1. $H_k(s)$ å’Œ $a(s)$ çš„å•è°ƒçº¦æŸå‡½æ•° (`MonotonicFunc`)

è¯¥ç±»å®ç°è¾¹ç•Œå¢å¼ºç»“æ„ $\psi(s, t)$ï¼Œè¦æ±‚ $f(0)=0$ å’Œ $f'(s) > 0$ã€‚

$$\psi(s, t) = ws + \mathbf{S}(z(s,t))$$
$$z(s,t) = \frac{1}{2}\left(1 + \frac{\sinh(Ax(t,s))}{\sinh(A)}\right)$$
$$x(t,s) = 2\frac{s}{t} - 1$$

* **ç»§æ‰¿ï¼š** `BSplineBase`
* **åŠŸèƒ½ï¼š** å®ç° $\psi(s, t)$ ç»“æ„ï¼Œé€šè¿‡ $b(s)$ å¸æ”¶åˆå§‹æ–œç‡ï¼Œé€šè¿‡ $\arccos$ å˜æ¢æé«˜è¾¹ç•Œæ‹Ÿåˆèƒ½åŠ›ã€‚
* **å‚æ•°ï¼š** `in_features=1`ï¼›`out_features` (1 for $a(s)$ï¼Œ $H$ for $H_k(s)$)ã€‚
* **ç½‘æ ¼èŒƒå›´ï¼š** B æ ·æ¡çš„å®šä¹‰åŸŸ $z(s, t)$ å¼ºåˆ¶ä¸º $(0,1)$ã€‚
* **å¯å­¦ä¹ å‚æ•°ï¼š**
    * `d`ï¼šæ ·æ¡ç³»æ•°çš„å¢é‡ $\Delta c_i$ (Parameter)ã€‚
    * `w_raw`ï¼šçº¿æ€§é¡¹ $w$ çš„åŸå§‹æƒé‡ã€‚(`w = F.softplus(w_{raw})`)ã€‚
    - `A_raw`: ç½‘æ ¼å¯†åº¦æ§åˆ¶é¡¹ï¼Œï¼ˆ`A = F.softplus(A_raw)`ï¼‰
* **æ–¹æ³•ï¼š**
    * `get_spline_coefficients()`ï¼šè®¡ç®—å•è°ƒç³»æ•° $c_i$ï¼Œå¹¶å¼ºåˆ¶ $\Delta c_{1}=\dots=\Delta c_k=0$ æ¥ä¿è¯ $\mathbf{S(0)=0}$ã€‚
    * `forward(s, t)`ï¼š
        1.  **éçº¿æ€§å˜æ¢ï¼š** è®¡ç®—éçº¿æ€§å˜åŒ–é¡¹ 
        $$x(t,s) = 2\frac{s}{t} - 1$$
        $$z(s,t) = \frac{1}{2}\left(1 + \frac{\sinh(Ax(t,s))}{\sinh(A)}\right)$$
        2.  **åŸºå‡½æ•°é¡¹ï¼š** è®¡ç®—åŸºå‡½æ•° $b(s)=ws$ã€‚
        3.  **æ ·æ¡é¡¹ï¼š** ä½¿ç”¨ $z$ è®¡ç®—æ ·æ¡é¡¹ $S(z)$ã€‚
        4.  **ç»„åˆï¼š** $\psi(s, t) = b(s) + S(z)$ã€‚
        * **è¾“å…¥**ï¼š`s` (shape `(B, 1)`)ï¼›`t` (shape `(B, 1)`)ã€‚
        * **è¾“å‡º**ï¼š`f_s` (shape `(B, out_features)`)ã€‚

### 3.2. $G_k(t)$ çš„æ’æ­£çº¦æŸå‡½æ•° (`GFunc`)

è¯¥ç±»ç”¨äº $G_k(t)$ï¼Œè¦æ±‚ $G_k(t) > 0$ã€‚

* **ç»§æ‰¿ï¼š** `BSplineBase`
* **åŠŸèƒ½ï¼š** å®ç° $G_k(t) = \text{softplus}(\text{silu}(t) + \text{spline}(t))$ çš„ç»“æ„ã€‚
* **å‚æ•°ï¼š** `in_features=1`ï¼›`out_features`=$H$ (`hidden_dim`)ã€‚
* **å¯å­¦ä¹ å‚æ•°ï¼š**
    * `coef`ï¼šæ ·æ¡ç³»æ•° $c_i$ (Parameter)ï¼Œ**æ— å•è°ƒçº¦æŸ**ã€‚
    * `linear`ï¼šå¯é€‰çš„çº¿æ€§å±‚ã€‚
* **æ–¹æ³•ï¼š**
    * `forward(x)`ï¼š
        1.  è®¡ç®—å†…éƒ¨å‡½æ•° $\tilde{G}_k(t) = \text{silu}(t) + \text{spline}(t)$ã€‚
        2.  å¯¹ $\tilde{G}_k(t)$ åº”ç”¨ $\text{softplus}$ åŒ…è£…å™¨ã€‚
        * **è¾“å…¥**ï¼š`x`ï¼š$t$ è¾“å…¥ï¼Œshape `(B, 1)`ã€‚
        * **è¾“å‡º**ï¼š$G_t$ï¼šæ’æ­£å‡½æ•°å€¼ï¼Œshape `(B, out_features)`ã€‚

-----

## âš¡ 4. æ€»æ–¹æ¡ˆï¼š`MonotonicKANLayer`

è¯¥ç±»é›†æˆä»¥ä¸Šæ‰€æœ‰å®šåˆ¶å‡½æ•°ï¼Œå®ç° $NN(t,s)$ çš„æœ€ç»ˆè®¡ç®—ã€‚

* **ç»§æ‰¿ï¼š** `torch.nn.Module`
* **åŠŸèƒ½ï¼š** ç»„åˆ $a(s, t)$, $G_k(t)$, $H_k(s, t)$ å®ç°æœ€ç»ˆçš„ $NN(t,s) = a(s, t) + \sum_k G_k(t)H_k(s, t)$ è¡¨è¾¾å¼ã€‚
* **å†…éƒ¨æ¨¡å—ï¼š**
    * `a_s_func`ï¼š`MonotonicFunc` å®ä¾‹ï¼Œ`out_features=1`ã€‚
    * `H_s_func`ï¼š`MonotonicFunc` å®ä¾‹ï¼Œ`out_features=$H$ (hidden\_dim)`ã€‚
    * `G_t_func`ï¼š`GFunc` å®ä¾‹ï¼Œ`out_features=$H$`ã€‚
* **æ–¹æ³•ï¼š**
    * `forward(x)`ï¼š
        1.  åˆ†ç¦» $t$ å’Œ $s$ è¾“å…¥ï¼š$t = x[:, 0:1]$, $s = x[:, 1:2]$ã€‚
        2.  è®¡ç®— $a(s, t) = \text{a\_s\_func}(\mathbf{s, t})$ã€‚
        3.  è®¡ç®— $G_k(t) = \text{G\_t\_func}(t)$ã€‚
        4.  è®¡ç®— $H_k(s, t) = \text{H\_s\_func}(\mathbf{s, t})$ã€‚
        5.  å‘é‡åŒ–ä¹˜ç§¯ï¼š$\text{product\_term} = G_k(t) \odot H_k(s, t)$ã€‚
        6.  æ²¿ $H$ ç»´åº¦æ±‚å’Œï¼š$\text{sum\_term} = \sum_k (\text{product\_term})$ã€‚
        7.  æœ€ç»ˆè¾“å‡º $NN(t,s) = a(s, t) + \text{sum\_term}$ã€‚
        * **è¾“å…¥**ï¼š`x`ï¼šç½‘ç»œçš„æ€»è¾“å…¥ $[t, s]$ï¼Œshape `(B, 2)`ã€‚
        * **è¾“å‡º**ï¼š`NN_ts`ï¼šé¢„æµ‹å€¼ï¼Œshape `(B, 1)`ã€‚

-----

## âš™ï¸ 5. å‘é‡åŒ– B æ ·æ¡è¾…åŠ©å‡½æ•°ï¼ˆ`C:\Users\31251\miniconda3\envs\pytorch\Lib\site-packages\kan\spline.py`ï¼‰

* **`B_batch`**
    * **æè¿°**ï¼šå‘é‡åŒ–è®¡ç®— $k$ é˜¶ B æ ·æ¡åŸºå‡½æ•°çš„å€¼ã€‚
    * **è¾“å…¥**ï¼š`x` (è¾“å…¥ç‚¹)ï¼›`grid` (ç½‘æ ¼)ã€‚
    * **è¾“å‡º**ï¼š`spline values` (åŸºå‡½æ•°å€¼ï¼Œshape `(B, in_dim, G+k)`)ã€‚
* **`coef2curve`**
    * **æè¿°**ï¼šå°† B æ ·æ¡ç³»æ•°è½¬åŒ–ä¸ºæ›²çº¿å€¼ï¼ˆå³æ ·æ¡å‡½æ•° $S(x)$ï¼‰ã€‚
    * **è¾“å…¥**ï¼š`x_eval` (è¾“å…¥ç‚¹)ï¼›`grid` (æ‰©å±•ç½‘æ ¼)ï¼›`coef` (æ ·æ¡ç³»æ•°)ã€‚
    * **è¾“å‡º**ï¼š`y_eval` (æ ·æ¡å‡½æ•°å€¼ï¼Œshape `(B, in_dim, out_dim)`)ã€‚
* **`extend_grid`**
    * **æè¿°**ï¼šæ‰©å±•ç½‘æ ¼ï¼Œç”¨äºæ»¡è¶³ B æ ·æ¡åœ¨è¾¹ç•Œå¤„çš„æ”¯æ’‘è¦æ±‚ã€‚
    * **è¾“å…¥**ï¼š`grid` (åˆå§‹ç½‘æ ¼ç‚¹)ã€‚
    * **è¾“å‡º**ï¼š`grid` (æ‰©å±•åçš„ç½‘æ ¼ç‚¹)ã€‚